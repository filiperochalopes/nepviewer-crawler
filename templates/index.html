<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NepViewer - Potência(W)</title>

    <!-- Alpine.js (CDN) -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <link rel="stylesheet" href="/static/app.css" />
  </head>

  <body>
    <div class="container" x-data="powerDashboard()">
      <header class="header">
        <div>
          <h1>NepViewer</h1>
          <p class="subtitle">Potência(W) coletada a cada 1 minuto (SQLite)</p>
        </div>
        <div class="badge">
          <span>Fuso:</span>
          <strong>America/Bahia</strong>
        </div>
      </header>

      <section class="controls">
        <div class="segmented">
          <button :class="mode==='month' ? 'active' : ''" @click="mode='month'; reload()">Por mês</button>
          <button :class="mode==='day' ? 'active' : ''" @click="mode='day'; reload()">Por dia</button>
        </div>

        <div class="stat-total" x-show="statValue !== null" style="margin-left: 1rem; font-weight: bold;">
          <span x-text="statLabel"></span>: <span x-text="statValue"></span> <span x-text="statUnit"></span>
        </div>

        <div class="inputs">
          <div x-show="mode==='month'">
            <label>Mês</label>
            <input type="month" x-model="month" @change="reload()" />
          </div>

          <div x-show="mode==='day'">
            <label>Dia</label>
            <input type="date" x-model="day" @change="reload()" />
          </div>

          <button class="refresh" @click="reload()">Atualizar</button>
        </div>
      </section>

      <section class="card">
        <div class="card-head">
          <h2 x-text="title"></h2>
          <div class="meta">
            <span x-text="status"></span>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="powerChart"></canvas>
        </div>
      </section>

      <section class="card">
        <div class="card-head">
          <h2>Últimos pontos</h2>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Label</th>
                <th x-text="statUnit === 'kWh' ? 'Energia (kWh)' : 'Potência (W)'"></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(row, idx) in previewRows" :key="idx">
                <tr>
                  <td x-text="row.label"></td>
                  <td x-text="row.value"></td>
                </tr>
              </template>
              <tr x-show="previewRows.length===0">
                <td colspan="2" class="muted">Sem dados para o filtro selecionado.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="card-head">
          <h2>Últimas aferições (10 min)</h2>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Potência (W)</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(row, idx) in recentRows" :key="idx">
                <tr>
                  <td x-text="row.label"></td>
                  <td x-text="row.value"></td>
                </tr>
              </template>
              <tr x-show="recentRows.length===0">
                <td colspan="2" class="muted">Sem aferições recentes.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script>
      function powerDashboard() {
        return {
          mode: "day",
          month: "{{ default_month }}",
          day: "{{ default_day }}",
          title: "Carregando...",
          status: "inicializando...",
          statLabel: "Pico",
          statValue: null,
          statUnit: "W",
          chart: null,
          previewRows: [],
          recentRows: [],

          async reload() {
            try {
              this.status = "carregando...";
              const params = new URLSearchParams();
              params.set("mode", this.mode);
              if (this.mode === "month") params.set("month", this.month);
              if (this.mode === "day") params.set("day", this.day);

              const res = await fetch(`/api/series?${params.toString()}`);
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              
              const data = await res.json();

              this.title = data.title || "Potência(W)";
              this.statLabel = data.stat_label || "Total";
              this.statValue = data.stat_value !== undefined ? data.stat_value : null;
              this.statUnit = data.stat_unit || "W";
              
              const labels = data.labels || [];
              const values = data.values || [];

              const pairs = labels.map((label, i) => ({ label, value: values[i] }));
              const nonNull = pairs.filter((p) => (
                p.value !== null && p.value !== undefined && !Number.isNaN(p.value)
              ));
              this.previewRows = nonNull.slice(-10).reverse();
              this.recentRows = data.recent_raw || [];

              this.renderChart(labels, values);
              this.status = `ok • pontos: ${labels.length}`;
            } catch (e) {
              console.error(e);
              this.status = "erro: " + (e.message || e);
            }
          },

          renderChart(labels, values) {
            if (typeof Chart === 'undefined') {
              throw new Error("Chart.js não carregado");
            }
            const ctx = document.getElementById("powerChart");
            if (!ctx) {
              throw new Error("Canvas #powerChart não encontrado");
            }

            const labelStr = this.statUnit === 'kWh' ? "Energia (kWh)" : "Potência (W)";
            const dataValues = (values || []).map((v) =>
              v === null || v === undefined || Number.isNaN(v) ? null : Number(v)
            );

            if (this.chart) {
              this.chart.destroy();
              this.chart = null;
            }

            this.chart = new Chart(ctx, {
              type: "line",
              data: {
                labels,
                datasets: [{
                  label: labelStr,
                  data: dataValues,
                  tension: 0.25,
                  pointRadius: 2,
                  spanGaps: false,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                plugins: {
                  legend: { display: true },
                  tooltip: { enabled: true }
                },
                scales: {
                  x: { ticks: { maxRotation: 0, autoSkip: true } },
                  y: { beginAtZero: false }
                }
              }
            });
          },

          init() {
            this.reload();
          }
        }
      }
    </script>
  </body>
</html>
